<% content_for :title, "#{@form_definition.code} - #{@form_definition.title}" %>

<div class="mb-6">
  <%= link_to "← Back to Forms", forms_path, class: "text-blue-600 hover:text-blue-800" %>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Form -->
  <div class="lg:col-span-2">
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900"><%= @form_definition.code %></h1>
            <p class="text-gray-600"><%= @form_definition.title %></p>
          </div>
          <div id="autosave-status" class="text-sm text-gray-500">
            <%= render partial: "shared/autosave_status", locals: { saved_at: @submission.updated_at } %>
          </div>
        </div>
      </div>

      <%= form_with model: @submission, url: form_path(@form_definition.code), method: :patch, local: false, data: { controller: "form", form_auto_save_url_value: form_path(@form_definition.code) } do |f| %>
        <div class="p-6 space-y-8">
          <% @sections.each do |section_name, fields| %>
            <div class="border-b pb-6 last:border-b-0 last:pb-0">
              <h2 class="text-lg font-semibold text-gray-900 mb-4 capitalize"><%= section_name.to_s.titleize %></h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <% fields.each do |field| %>
                  <div class="<%= field.width_class %>">
                    <%= render partial: "forms/fields/#{field.field_type}", locals: { field: field, form: f, submission: @submission } rescue render partial: "forms/fields/text", locals: { field: field, form: f, submission: @submission } %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @field_definitions.empty? %>
            <div class="text-center py-8 text-gray-500">
              <p>This form's fields haven't been configured yet.</p>
              <p class="text-sm mt-2">Check back soon or download the blank PDF below.</p>
            </div>
          <% end %>
        </div>

        <div class="p-6 bg-gray-50 border-t flex items-center justify-between">
          <div class="flex space-x-4">
            <%= f.submit "Save", class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium cursor-pointer" %>
          </div>

          <div class="flex space-x-4">
            <%= link_to preview_form_path(@form_definition.code), target: "_blank", class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              Preview PDF
            <% end %>

            <%= link_to download_form_path(@form_definition.code), class: "inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              Download PDF
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">
    <!-- Form Info -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="font-semibold text-gray-900 mb-4">About This Form</h3>
      <% if @form_definition.description.present? %>
        <p class="text-sm text-gray-600 mb-4"><%= @form_definition.description %></p>
      <% end %>

      <dl class="space-y-2 text-sm">
        <div class="flex justify-between">
          <dt class="text-gray-500">Form Code</dt>
          <dd class="font-medium text-gray-900"><%= @form_definition.code %></dd>
        </div>
        <% if @form_definition.page_count %>
          <div class="flex justify-between">
            <dt class="text-gray-500">Pages</dt>
            <dd class="font-medium text-gray-900"><%= @form_definition.page_count %></dd>
          </div>
        <% end %>
        <div class="flex justify-between">
          <dt class="text-gray-500">Progress</dt>
          <dd class="font-medium text-gray-900"><%= @submission.completion_percentage %>%</dd>
        </div>
      </dl>
    </div>

    <!-- Help -->
    <div class="bg-blue-50 rounded-lg p-6">
      <h3 class="font-semibold text-blue-900 mb-2">Need Help?</h3>
      <p class="text-sm text-blue-700 mb-4">
        Visit the California Courts Self-Help Center for guidance on this form.
      </p>
      <a href="https://selfhelp.courts.ca.gov/small-claims" target="_blank" class="text-sm font-medium text-blue-600 hover:text-blue-800">
        Go to Self-Help Center →
      </a>
    </div>

    <!-- Download Original -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="font-semibold text-gray-900 mb-2">Official Form</h3>
      <p class="text-sm text-gray-600 mb-4">
        Download the blank official form from the California Courts.
      </p>
      <% if @form_definition.pdf_exists? %>
        <a href="https://www.courts.ca.gov/documents/<%= @form_definition.pdf_filename %>" target="_blank" class="text-sm font-medium text-blue-600 hover:text-blue-800">
          Download Original PDF →
        </a>
      <% end %>
    </div>
  </div>
</div>
