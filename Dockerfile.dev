# syntax=docker/dockerfile:1

# Development Dockerfile for California Small Claims Forms
# Use with docker-compose.yml: docker compose up

ARG RUBY_VERSION=3.4.7
FROM docker.io/library/ruby:$RUBY_VERSION-slim

# Rails app lives here
WORKDIR /rails

# Install development dependencies
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
      build-essential \
      curl \
      git \
      libpq-dev \
      libyaml-dev \
      libvips \
      pkg-config \
      postgresql-client \
      pdftk-java \
      nodejs \
      npm \
      chromium \
      chromium-driver \
      && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install Node.js LTS for asset compilation and Puppeteer (used by Grover for PDF generation)
RUN npm install -g n && n lts && npm install -g npm@latest

# Set Puppeteer to use system Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium \
    GROVER_NO_SANDBOX=true

# Set development environment
ENV RAILS_ENV=development \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT=""

# Install bundler
RUN gem install bundler

# Copy Gemfile and ruby version first for better caching
COPY Gemfile Gemfile.lock .ruby-version ./

# Install gems
RUN bundle install

# Copy package files and install npm dependencies
COPY package.json package-lock.json ./
RUN npm install

# Copy the rest of the application
COPY . .

# Expose Rails server port
EXPOSE 3000

# Default command
CMD ["bin/dev"]
